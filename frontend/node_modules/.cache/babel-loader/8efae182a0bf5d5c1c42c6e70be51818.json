{"ast":null,"code":"import _objectSpread from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _assertThisInitialized from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";import _inherits from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React,{Component}from\"react\";import\"./View.css\";import Model from\"./Model.js\";import axios from\"axios\";import AudioRecorder from\"./AudioRecorder.js\";import\"./Slider.css\";import{Transition}from\"react-transition-group\";import{login,authFetch,useAuth,logout}from\"../auth\";var AUDIO_FRAME=10;var FPS=60;var defaultStyle={transition:\"opacity \".concat(300,\"ms ease-in-out\"),opacity:0};var transitionStyles={entering:{opacity:1},entered:{opacity:1},exiting:{opacity:0},exited:{opacity:0}};var View=/*#__PURE__*/function(_Component){_inherits(View,_Component);var _super=_createSuper(View);function View(props){var _this;_classCallCheck(this,View);_this=_super.call(this,props);_this.state={file:undefined,animationStatus:\"STOP\",visemes:undefined,inputProcessed:false,sliderValue:0.4,popup:false,popupText:\"\"};_this.move=0.02;_this.delta=0;_this.modelControlActive=false;_this.currentFrame=0;_this.lidMove=0.1;_this.lidSpeed=0.1;_this.lidWait=1;_this.play=_this.play.bind(_assertThisInitialized(_this));_this.pause=_this.pause.bind(_assertThisInitialized(_this));_this.stop=_this.stop.bind(_assertThisInitialized(_this));_this.processResponse=_this.processResponse.bind(_assertThisInitialized(_this));_this.fetchInput=_this.fetchInput.bind(_assertThisInitialized(_this));_this.playAnimation=_this.playAnimation.bind(_assertThisInitialized(_this));_this.pauseAnimation=_this.pauseAnimation.bind(_assertThisInitialized(_this));_this.stopAnimation=_this.stopAnimation.bind(_assertThisInitialized(_this));_this.handleFile=_this.handleFile.bind(_assertThisInitialized(_this));_this.sendFile=_this.sendFile.bind(_assertThisInitialized(_this));_this.handleSlider=_this.handleSlider.bind(_assertThisInitialized(_this));_this.handleRecording=_this.handleRecording.bind(_assertThisInitialized(_this));_this.openPopup=_this.openPopup.bind(_assertThisInitialized(_this));_this.closePopup=_this.closePopup.bind(_assertThisInitialized(_this));return _this;}_createClass(View,[{key:\"componentDidMount\",value:function componentDidMount(){this.fetchInput();this.audio=new Audio();this.audio.loop=true;this.setState({mounted:true});}},{key:\"componentDidUpdate\",value:function componentDidUpdate(){}},{key:\"fetchInput\",value:function fetchInput(){fetch(\"/api/time\").then(function(res){return res.json();}).then(function(data){console.log(data);});}},{key:\"calculateDistance\",value:function calculateDistance(point1,point2){return Math.sqrt(Math.pow(point1[0]-point2[0],2)+Math.pow(point1[1]-point2[1],2));}},{key:\"processResponse\",value:function processResponse(response){var step=1000/AUDIO_FRAME/FPS;var result=[],frame=undefined,j=undefined;for(var i=0;i<response.length;i+=step){// change the frequency of the visemes from 100Hz to 60Hz\nframe=response.slice(i,i+step)[0];result.push(frame);j=result.length-1;if(j>=3){// eliminate singular visemes\nif(result[j-2]!==result[j-1]&&result[j-1]!==result[j]){result[result.length-2]=result[result.length-3];}}if(j>=4){// eliminate double visemes\nif(result[j]!==result[j-1]){if(!(result[j-1]===result[j-2]&&result[j-2]===result[j-3])){result[j-1]=result[j];result[j-2]=result[j-3];}}}}this.setState({visemes:result,inputProcessed:true});}},{key:\"maxElement\",value:function maxElement(array){if(array.length===0)return null;var modeMap={};var maxEl=array[0],maxCount=1;for(var i=0;i<array.length;i++){var el=array[i];if(modeMap[el]==null)modeMap[el]=1;else modeMap[el]++;if(modeMap[el]>maxCount){maxEl=el;maxCount=modeMap[el];}}return maxEl;}},{key:\"stop\",value:function stop(){if(this.state.animationStatus===\"PLAY\"||this.state.animationStatus===\"PAUSE\"){this.audio.pause();this.audio.currentTime=0;this.setState({animationStatus:\"STOP\"});}}},{key:\"play\",value:function play(){if(this.state.animationStatus===\"STOP\"||this.state.animationStatus===\"PAUSE\"){this.audio.play();this.setState({animationStatus:\"PLAY\"});}}},{key:\"pause\",value:function pause(){if(this.state.animationStatus===\"PLAY\"){this.audio.pause();this.setState({animationStatus:\"PAUSE\"});}}},{key:\"playAnimation\",value:function playAnimation(){if(!this.state.inputProcessed){this.openPopup(\"Upload the audio file to the server!\");}else{this.play();}}},{key:\"stopAnimation\",value:function stopAnimation(){if(!this.state.inputProcessed){this.openPopup(\"Upload the audio file to the server!\");}else{this.stop();}}},{key:\"pauseAnimation\",value:function pauseAnimation(){if(!this.state.inputProcessed){this.openPopup(\"Upload the audio file to the server!\");}else{this.pause();}}},{key:\"handleFile\",value:function handleFile(event){console.log(event.target.files);if(event.target.files.length>0){var fileData=event.target.files[0];var fileSource=URL.createObjectURL(fileData);this.stop();this.setState({file:fileData,inputProcessed:false,filename:fileData.name});this.audio.src=fileSource;}}},{key:\"handleRecording\",value:function handleRecording(recording){this.stop();this.setState({file:recording,inputProcessed:false,filename:\"Recording\"});this.audio.src=URL.createObjectURL(recording);console.log(this.state.file,this.audio.src);}},{key:\"sendFile\",value:function(){var _sendFile=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _this2=this;var data;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.state.file){data=new FormData();data.append(\"file\",this.state.file);this.setState({inputProcessed:undefined});this.stop();authFetch(\"/api/upload\",{method:\"POST\",body:data}).then(function(res){console.log(res);if(res.status===401){_this2.setState({inputProcessed:false});_this2.openPopup(\"Sorry you aren't authorized!\");return null;}else if(res.status!==200){_this2.setState({inputProcessed:false});_this2.openPopup(\"Server failure!\");return null;}return res.json();}).then(function(res){console.log(res);if(res){if(res.status===200){_this2.processResponse(res.result);}else if(res.message===\"Extension\"){_this2.setState({inputProcessed:false});_this2.openPopup(\"Incorrect extension! Upload .wav and .mp3 files.\");}else if(res.message===\"Model\"){_this2.setState({inputProcessed:false});_this2.openPopup(\"Model failure!\");}}});}else{this.openPopup(\"Choose a file!\");}case 1:case\"end\":return _context.stop();}}},_callee,this);}));function sendFile(){return _sendFile.apply(this,arguments);}return sendFile;}()},{key:\"handleSlider\",value:function handleSlider(event){this.setState({sliderValue:event.target.value});}},{key:\"openPopup\",value:function openPopup(text){this.setState({popup:true,popupText:text});}},{key:\"closePopup\",value:function closePopup(){this.setState({popup:false,popupText:\"\"});}},{key:\"render\",value:function render(){var _this3=this;return/*#__PURE__*/React.createElement(\"div\",{id:\"view-container\"},/*#__PURE__*/React.createElement(Transition,{in:this.state.popup},function(state){return/*#__PURE__*/React.createElement(\"div\",{style:_objectSpread(_objectSpread({},defaultStyle),transitionStyles[state])},_this3.state.popup&&/*#__PURE__*/React.createElement(\"div\",{className:\"background\"},/*#__PURE__*/React.createElement(\"div\",{className:\"popup\"},/*#__PURE__*/React.createElement(\"div\",{id:\"popup-text\"},_this3.state.popupText),/*#__PURE__*/React.createElement(\"button\",{id:\"popup-close\",onClick:_this3.closePopup},\"X\"))));}),/*#__PURE__*/React.createElement(Transition,{in:this.state.inputProcessed===undefined},function(state){return/*#__PURE__*/React.createElement(\"div\",{style:_objectSpread(_objectSpread({},defaultStyle),transitionStyles[state])},_this3.state.inputProcessed===undefined&&/*#__PURE__*/React.createElement(\"div\",{className:\"background\"},/*#__PURE__*/React.createElement(\"div\",{className:\"loader\"})));}),/*#__PURE__*/React.createElement(\"div\",{className:\"top vertical\"},/*#__PURE__*/React.createElement(AudioRecorder,{newRecording:this.handleRecording}),/*#__PURE__*/React.createElement(\"label\",{className:\"styled-button horizontal\"},/*#__PURE__*/React.createElement(\"div\",null,\"Choose file\"),/*#__PURE__*/React.createElement(\"div\",{id:\"chosen-file\"},this.state.filename),/*#__PURE__*/React.createElement(\"input\",{id:\"choose-file\",type:\"file\",accept:\"audio/wav, audio/mp3\",onChange:this.handleFile,multiple:false})),/*#__PURE__*/React.createElement(\"button\",{id:\"upload-button\",className:\"styled-button narrow\",onClick:this.sendFile},\"Upload\")),/*#__PURE__*/React.createElement(Model,{id:\"model\",animationStatus:this.state.animationStatus,visemes:this.state.visemes,sliderValue:this.state.sliderValue}),/*#__PURE__*/React.createElement(\"div\",{className:\"bottom horizontal\"},/*#__PURE__*/React.createElement(\"button\",{id:\"play\",className:\"player styled-button\",onClick:this.playAnimation},\"Play\"),/*#__PURE__*/React.createElement(\"button\",{id:\"pause\",className:\"player styled-button\",onClick:this.pauseAnimation},\"Pause\"),/*#__PURE__*/React.createElement(\"button\",{id:\"stop\",className:\"player styled-button\",onClick:this.stopAnimation},\"Stop\"),/*#__PURE__*/React.createElement(\"span\",{className:\"spacer\"}),/*#__PURE__*/React.createElement(\"div\",{id:\"slider-container\",className:\"player\"},/*#__PURE__*/React.createElement(\"input\",{type:\"range\",id:\"slider\",min:0.1,max:1,value:this.state.sliderValue,step:0.05,onChange:this.handleSlider}),/*#__PURE__*/React.createElement(\"div\",null,this.state.sliderValue))));}}]);return View;}(Component);export default View;","map":{"version":3,"sources":["/home/filip/Desktop/facial-animation/frontend/src/components/View.js"],"names":["React","Component","Model","axios","AudioRecorder","Transition","login","authFetch","useAuth","logout","AUDIO_FRAME","FPS","defaultStyle","transition","opacity","transitionStyles","entering","entered","exiting","exited","View","props","state","file","undefined","animationStatus","visemes","inputProcessed","sliderValue","popup","popupText","move","delta","modelControlActive","currentFrame","lidMove","lidSpeed","lidWait","play","bind","pause","stop","processResponse","fetchInput","playAnimation","pauseAnimation","stopAnimation","handleFile","sendFile","handleSlider","handleRecording","openPopup","closePopup","audio","Audio","loop","setState","mounted","fetch","then","res","json","data","console","log","point1","point2","Math","sqrt","pow","response","step","result","frame","j","i","length","slice","push","array","modeMap","maxEl","maxCount","el","currentTime","event","target","files","fileData","fileSource","URL","createObjectURL","filename","name","src","recording","FormData","append","method","body","status","message","value","text"],"mappings":"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","sourcesContent":["import React, { Component } from \"react\";\nimport \"./View.css\";\nimport Model from \"./Model.js\";\nimport axios from \"axios\";\nimport AudioRecorder from \"./AudioRecorder.js\";\nimport \"./Slider.css\";\nimport { Transition } from \"react-transition-group\";\nimport { login, authFetch, useAuth, logout } from \"../auth\";\n\nconst AUDIO_FRAME = 10;\nconst FPS = 60;\n\nconst defaultStyle = {\n  transition: `opacity ${300}ms ease-in-out`,\n  opacity: 0,\n};\n\nconst transitionStyles = {\n  entering: { opacity: 1 },\n  entered: { opacity: 1 },\n  exiting: { opacity: 0 },\n  exited: { opacity: 0 },\n};\n\nclass View extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      file: undefined,\n      animationStatus: \"STOP\",\n      visemes: undefined,\n      inputProcessed: false,\n      sliderValue: 0.4,\n      popup: false,\n      popupText: \"\",\n    };\n\n    this.move = 0.02;\n    this.delta = 0;\n\n    this.modelControlActive = false;\n\n    this.currentFrame = 0;\n\n    this.lidMove = 0.1;\n    this.lidSpeed = 0.1;\n    this.lidWait = 1;\n\n    this.play = this.play.bind(this);\n    this.pause = this.pause.bind(this);\n    this.stop = this.stop.bind(this);\n    this.processResponse = this.processResponse.bind(this);\n    this.fetchInput = this.fetchInput.bind(this);\n    this.playAnimation = this.playAnimation.bind(this);\n    this.pauseAnimation = this.pauseAnimation.bind(this);\n    this.stopAnimation = this.stopAnimation.bind(this);\n    this.handleFile = this.handleFile.bind(this);\n    this.sendFile = this.sendFile.bind(this);\n    this.handleSlider = this.handleSlider.bind(this);\n    this.handleRecording = this.handleRecording.bind(this);\n    this.openPopup = this.openPopup.bind(this);\n    this.closePopup = this.closePopup.bind(this);\n  }\n\n  componentDidMount() {\n    this.fetchInput();\n\n    this.audio = new Audio();\n    this.audio.loop = true;\n    this.setState({\n      mounted: true,\n    });\n  }\n\n  componentDidUpdate() {}\n\n  fetchInput() {\n    fetch(\"/api/time\")\n      .then((res) => res.json())\n      .then((data) => {\n        console.log(data);\n      });\n  }\n\n  calculateDistance(point1, point2) {\n    return Math.sqrt(\n      Math.pow(point1[0] - point2[0], 2) + Math.pow(point1[1] - point2[1], 2)\n    );\n  }\n\n  processResponse(response) {\n    const step = 1000 / AUDIO_FRAME / FPS;\n    var result = [],\n      frame = undefined,\n      j = undefined;\n    for (var i = 0; i < response.length; i += step) {\n      // change the frequency of the visemes from 100Hz to 60Hz\n      frame = response.slice(i, i + step)[0];\n      result.push(frame);\n      j = result.length - 1;\n      if (j >= 3) {\n        // eliminate singular visemes\n        if (result[j - 2] !== result[j - 1] && result[j - 1] !== result[j]) {\n          result[result.length - 2] = result[result.length - 3];\n        }\n      }\n      if (j >= 4) {\n        // eliminate double visemes\n        if (result[j] !== result[j - 1]) {\n          if (\n            !(\n              result[j - 1] === result[j - 2] && result[j - 2] === result[j - 3]\n            )\n          ) {\n            result[j - 1] = result[j];\n            result[j - 2] = result[j - 3];\n          }\n        }\n      }\n    }\n    this.setState({\n      visemes: result,\n      inputProcessed: true,\n    });\n  }\n\n  maxElement(array) {\n    if (array.length === 0) return null;\n    var modeMap = {};\n    var maxEl = array[0],\n      maxCount = 1;\n    for (var i = 0; i < array.length; i++) {\n      var el = array[i];\n      if (modeMap[el] == null) modeMap[el] = 1;\n      else modeMap[el]++;\n      if (modeMap[el] > maxCount) {\n        maxEl = el;\n        maxCount = modeMap[el];\n      }\n    }\n    return maxEl;\n  }\n\n  stop() {\n    if (\n      this.state.animationStatus === \"PLAY\" ||\n      this.state.animationStatus === \"PAUSE\"\n    ) {\n      this.audio.pause();\n      this.audio.currentTime = 0;\n      this.setState({ animationStatus: \"STOP\" });\n    }\n  }\n\n  play() {\n    if (\n      this.state.animationStatus === \"STOP\" ||\n      this.state.animationStatus === \"PAUSE\"\n    ) {\n      this.audio.play();\n      this.setState({ animationStatus: \"PLAY\" });\n    }\n  }\n\n  pause() {\n    if (this.state.animationStatus === \"PLAY\") {\n      this.audio.pause();\n      this.setState({ animationStatus: \"PAUSE\" });\n    }\n  }\n\n  playAnimation() {\n    if (!this.state.inputProcessed) {\n      this.openPopup(\"Upload the audio file to the server!\");\n    } else {\n      this.play();\n    }\n  }\n\n  stopAnimation() {\n    if (!this.state.inputProcessed) {\n      this.openPopup(\"Upload the audio file to the server!\");\n    } else {\n      this.stop();\n    }\n  }\n\n  pauseAnimation() {\n    if (!this.state.inputProcessed) {\n      this.openPopup(\"Upload the audio file to the server!\");\n    } else {\n      this.pause();\n    }\n  }\n\n  handleFile(event) {\n    console.log(event.target.files);\n    if (event.target.files.length > 0) {\n      var fileData = event.target.files[0];\n      var fileSource = URL.createObjectURL(fileData);\n\n      this.stop();\n      this.setState({\n        file: fileData,\n        inputProcessed: false,\n        filename: fileData.name,\n      });\n      this.audio.src = fileSource;\n    }\n  }\n\n  handleRecording(recording) {\n    this.stop();\n    this.setState({\n      file: recording,\n      inputProcessed: false,\n      filename: \"Recording\",\n    });\n    this.audio.src = URL.createObjectURL(recording);\n\n    console.log(this.state.file, this.audio.src);\n  }\n\n  async sendFile() {\n    if (this.state.file) {\n      const data = new FormData();\n      data.append(\"file\", this.state.file);\n\n      this.setState({ inputProcessed: undefined });\n      this.stop();\n\n      authFetch(\"/api/upload\", { method: \"POST\", body: data })\n        .then((res) => {\n          console.log(res);\n          if (res.status === 401) {\n            this.setState({ inputProcessed: false });\n            this.openPopup(\"Sorry you aren't authorized!\");\n            return null;\n          } else if (res.status !== 200) {\n            this.setState({ inputProcessed: false });\n            this.openPopup(\"Server failure!\");\n            return null;\n          }\n          return res.json();\n        })\n        .then((res) => {\n          console.log(res);\n          if (res) {\n            if (res.status === 200) {\n              this.processResponse(res.result);\n            } else if (res.message === \"Extension\") {\n              this.setState({ inputProcessed: false });\n              this.openPopup(\n                \"Incorrect extension! Upload .wav and .mp3 files.\"\n              );\n            } else if (res.message === \"Model\") {\n              this.setState({ inputProcessed: false });\n              this.openPopup(\"Model failure!\");\n            }\n          }\n        });\n    } else {\n      this.openPopup(\"Choose a file!\");\n    }\n  }\n\n  handleSlider(event) {\n    this.setState({\n      sliderValue: event.target.value,\n    });\n  }\n\n  openPopup(text) {\n    this.setState({\n      popup: true,\n      popupText: text,\n    });\n  }\n\n  closePopup() {\n    this.setState({\n      popup: false,\n      popupText: \"\",\n    });\n  }\n\n  render() {\n    return (\n      <div id=\"view-container\">\n        <Transition in={this.state.popup}>\n          {(state) => (\n            <div\n              style={{\n                ...defaultStyle,\n                ...transitionStyles[state],\n              }}\n            >\n              {this.state.popup && (\n                <div className=\"background\">\n                  <div className=\"popup\">\n                    <div id=\"popup-text\">{this.state.popupText}</div>\n                    <button id=\"popup-close\" onClick={this.closePopup}>\n                      X\n                    </button>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </Transition>\n        <Transition in={this.state.inputProcessed === undefined}>\n          {(state) => (\n            <div\n              style={{\n                ...defaultStyle,\n                ...transitionStyles[state],\n              }}\n            >\n              {this.state.inputProcessed === undefined && (\n                <div className=\"background\">\n                  <div className=\"loader\"></div>\n                </div>\n              )}\n            </div>\n          )}\n        </Transition>\n        <div className=\"top vertical\">\n          <AudioRecorder newRecording={this.handleRecording} />\n          <label className=\"styled-button horizontal\">\n            <div>Choose file</div>\n            <div id=\"chosen-file\">{this.state.filename}</div>\n            <input\n              id=\"choose-file\"\n              type=\"file\"\n              accept=\"audio/wav, audio/mp3\"\n              onChange={this.handleFile}\n              multiple={false}\n            />\n          </label>\n          <button\n            id=\"upload-button\"\n            className=\"styled-button narrow\"\n            onClick={this.sendFile}\n          >\n            Upload\n          </button>\n        </div>\n        <Model\n          id=\"model\"\n          animationStatus={this.state.animationStatus}\n          visemes={this.state.visemes}\n          sliderValue={this.state.sliderValue}\n        />\n        <div className=\"bottom horizontal\">\n          <button\n            id=\"play\"\n            className=\"player styled-button\"\n            onClick={this.playAnimation}\n          >\n            Play\n          </button>\n          <button\n            id=\"pause\"\n            className=\"player styled-button\"\n            onClick={this.pauseAnimation}\n          >\n            Pause\n          </button>\n          <button\n            id=\"stop\"\n            className=\"player styled-button\"\n            onClick={this.stopAnimation}\n          >\n            Stop\n          </button>\n          <span className=\"spacer\" />\n          <div id=\"slider-container\" className=\"player\">\n            <input\n              type=\"range\"\n              id=\"slider\"\n              min={0.1}\n              max={1}\n              value={this.state.sliderValue}\n              step={0.05}\n              onChange={this.handleSlider}\n            />\n            <div>{this.state.sliderValue}</div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default View;\n"]},"metadata":{},"sourceType":"module"}