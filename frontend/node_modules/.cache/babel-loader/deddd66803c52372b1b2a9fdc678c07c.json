{"ast":null,"code":"import _createForOfIteratorHelper from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _toConsumableArray from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _assertThisInitialized from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/assertThisInitialized\";import _inherits from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/filip/Desktop/facial-animation/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React,{Component}from'react';import*as THREE from'three';import{GLTFLoader}from'three/examples/jsm/loaders/GLTFLoader.js';import{OrbitControls}from'three/examples/jsm/controls/OrbitControls.js';import{SkeletonUtils}from'three/examples/jsm/utils/SkeletonUtils.js';var Model=/*#__PURE__*/function(_Component){_inherits(Model,_Component);var _super=_createSuper(Model);function Model(props){var _this;_classCallCheck(this,Model);_this=_super.call(this,props);_this.state={animationStatus:_this.props.animationStatus,intensity:_this.props.sliderValue};_this.visemes=undefined;_this.visemesNames=undefined;_this.move=0.02;_this.delta=0;_this.modelControlActive=false;_this.currentFrame=1;_this.lidMove=0.1;_this.lidSpeed=0.1;_this.lidWait=1;_this.exponent=6;_this.obamaRatio=[0.8,0.8];_this.start=_this.start.bind(_assertThisInitialized(_this));_this.animate=_this.animate.bind(_assertThisInitialized(_this));_this.onWindowResize=_this.onWindowResize.bind(_assertThisInitialized(_this));_this.addCube=_this.addCube.bind(_assertThisInitialized(_this));_this.addModel=_this.addModel.bind(_assertThisInitialized(_this));_this.getMouthControl=_this.getModelControl.bind(_assertThisInitialized(_this));_this.moveLid=_this.moveLid.bind(_assertThisInitialized(_this));_this.nextViseme=_this.nextViseme.bind(_assertThisInitialized(_this));_this.resetModel=_this.resetModel.bind(_assertThisInitialized(_this));return _this;}_createClass(Model,[{key:\"componentDidMount\",value:function componentDidMount(){var width=window.innerWidth;var height=window.innerHeight;this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(75,width/height,0.1,1000);this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});var light=new THREE.HemisphereLight(0xBEDDED,0xDECADE,0.55);this.scene.add(light);light=new THREE.SpotLight(0xffffff,0.75);light.position.set(-80,100,100);light.castShadow=true;this.scene.add(light);this.addModel();this.camera.position.z=0.5;this.camera.position.y=0;this.controls=new OrbitControls(this.camera,this.renderer.domElement);this.controls.update();this.renderer.setClearColor('#ffffff');this.renderer.setSize(width,height);window.addEventListener('resize',this.onWindowResize,false);this.mount.appendChild(this.renderer.domElement);this.start();}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(prevProps.animationStatus!==this.props.animationStatus){this.setState({animationStatus:this.props.animationStatus});}if(prevProps.visemes!==this.props.visemes){this.visemes=this.props.visemes;this.visemesNames=_toConsumableArray(new Set(this.props.visemes));this.currentFrame=1;console.log(this.visemes);console.log(this.visemesNames);}if(prevProps.sliderValue!==this.props.sliderValue){this.setState({intensity:this.props.sliderValue});}}},{key:\"addCube\",value:function addCube(x,y,z){var geometry=new THREE.BoxGeometry(.1,.1,.1);geometry.translate(x,y,z);var material=new THREE.MeshBasicMaterial({color:'#433F81'});var cube=new THREE.Mesh(geometry,material);this.scene.add(cube);}},{key:\"addModel\",value:function addModel(){var _this2=this;var loader=new GLTFLoader();loader.load('model/head_visemes.gltf',function(gltf){_this2.model=SkeletonUtils.clone(gltf.scene);console.log(_this2.model);_this2.scene.add(_this2.model);_this2.getModelControl();_this2.renderScene();},undefined,function(error){console.error(error);});}},{key:\"onWindowResize\",value:function onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(window.innerWidth,window.innerHeight);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.mount.removeChild(this.renderer.domElement);}},{key:\"start\",value:function start(){if(!this.frameId){this.frameId=requestAnimationFrame(this.animate);}}},{key:\"getModelControl\",value:function getModelControl(){var _this3=this;if(this.model){this.model.traverse(function(o){if(o.isMesh&&o.name==='head'){_this3.modelControl=o.morphTargetInfluences;_this3.modelControlDict=o.morphTargetDictionary;_this3.modelControlActive=true;}});}}},{key:\"calculateDistance\",value:function calculateDistance(point1,point2){return Math.sqrt(Math.pow(point1[0]-point2[0],2)+Math.pow(point1[1]-point2[1],2));}},{key:\"moveLid\",value:function moveLid(){if(this.modelControl[this.modelControlDict['wink']]<=0){if(this.lidWait>100){this.lidMove=this.lidSpeed;this.lidWait=0;}else{this.lidMove=0;}this.lidWait+=1;}else if(this.modelControl[this.modelControlDict['wink']]>1){this.lidMove=-this.lidMove;}this.modelControl[this.modelControlDict['wink']]=this.modelControl[this.modelControlDict['wink']]+this.lidMove;}},{key:\"nextViseme\",value:function nextViseme(){if(this.currentFrame<1)this.currentFrame=1;var currViseme=this.visemes[this.currentFrame];var prevViseme=this.visemes[this.currentFrame-1];var _iterator=_createForOfIteratorHelper(this.visemesNames),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var visemeName=_step.value;if(visemeName===currViseme){this.modelControl[this.modelControlDict[visemeName]]+=this.state.intensity/this.exponent;//Math.pow(this.state.intensity, this.exponent)\nif(this.modelControl[this.modelControlDict[visemeName]]>1)this.modelControl[this.modelControlDict[visemeName]]=1;}else{this.modelControl[this.modelControlDict[visemeName]]-=this.state.intensity/(10-this.exponent);//Math.pow(this.state.intensity, this.exponent)\nif(this.modelControl[this.modelControlDict[visemeName]]<0)this.modelControl[this.modelControlDict[visemeName]]=0;}}}catch(err){_iterator.e(err);}finally{_iterator.f();}if(currViseme===prevViseme){this.exponent-=1;if(this.exponent<2)this.exponent=2;}else this.exponent=8;}},{key:\"resetModel\",value:function resetModel(){this.lidWait=0;if(this.modelControl){for(var i=0;i<this.modelControl.length;i++){this.modelControl[i]=0;}}}},{key:\"animate\",value:function animate(){if(this.state.animationStatus==='PLAY'&&this.modelControlActive){this.nextViseme();this.moveLid();if(this.currentFrame>=this.visemes.length){this.currentFrame=0;}this.currentFrame+=1;}else if(this.state.animationStatus===\"STOP\"){this.currentFrame=1;this.resetModel();}this.controls.update();this.renderScene();this.frameId=window.requestAnimationFrame(this.animate);}},{key:\"renderScene\",value:function renderScene(){this.renderer.render(this.scene,this.camera);}},{key:\"render\",value:function render(){var _this4=this;return/*#__PURE__*/React.createElement(\"div\",{ref:function ref(mount){_this4.mount=mount;}});}}]);return Model;}(Component);export default Model;","map":{"version":3,"sources":["/home/filip/Desktop/facial-animation/frontend/src/components/Model.js"],"names":["React","Component","THREE","GLTFLoader","OrbitControls","SkeletonUtils","Model","props","state","animationStatus","intensity","sliderValue","visemes","undefined","visemesNames","move","delta","modelControlActive","currentFrame","lidMove","lidSpeed","lidWait","exponent","obamaRatio","start","bind","animate","onWindowResize","addCube","addModel","getMouthControl","getModelControl","moveLid","nextViseme","resetModel","width","window","innerWidth","height","innerHeight","scene","Scene","camera","PerspectiveCamera","renderer","WebGLRenderer","antialias","alpha","light","HemisphereLight","add","SpotLight","position","set","castShadow","z","y","controls","domElement","update","setClearColor","setSize","addEventListener","mount","appendChild","prevProps","setState","Set","console","log","x","geometry","BoxGeometry","translate","material","MeshBasicMaterial","color","cube","Mesh","loader","load","gltf","model","clone","renderScene","error","aspect","updateProjectionMatrix","removeChild","frameId","requestAnimationFrame","traverse","o","isMesh","name","modelControl","morphTargetInfluences","modelControlDict","morphTargetDictionary","point1","point2","Math","sqrt","pow","currViseme","prevViseme","visemeName","i","length","render"],"mappings":"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","sourcesContent":["import React, { Component } from 'react'\nimport * as THREE from 'three'\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js'\nimport { SkeletonUtils } from 'three/examples/jsm/utils/SkeletonUtils.js'\n\n\nclass Model extends Component {\n  constructor(props) {\n    super(props)\n    this.state = {\n        animationStatus: this.props.animationStatus,\n        intensity: this.props.sliderValue\n    }\n\n    this.visemes = undefined\n    this.visemesNames = undefined\n\n    this.move = 0.02\n    this.delta = 0\n\n    this.modelControlActive = false\n\n    this.currentFrame = 1\n\n    this.lidMove = 0.1\n    this.lidSpeed = 0.1\n    this.lidWait = 1\n\n    this.exponent = 6\n\n    this.obamaRatio = [0.8, 0.8]\n\n    this.start = this.start.bind(this)\n    this.animate = this.animate.bind(this)\n    this.onWindowResize = this.onWindowResize.bind(this)\n    this.addCube = this.addCube.bind(this)\n    this.addModel = this.addModel.bind(this)\n    this.getMouthControl = this.getModelControl.bind(this)\n    this.moveLid = this.moveLid.bind(this)\n    this.nextViseme = this.nextViseme.bind(this)\n    this.resetModel = this.resetModel.bind(this)\n  }\n\n  componentDidMount() {\n    const width = window.innerWidth\n    const height = window.innerHeight\n\n    this.scene = new THREE.Scene()\n    this.camera = new THREE.PerspectiveCamera(\n      75,\n      width / height,\n      0.1,\n      1000\n    )\n    this.renderer = new THREE.WebGLRenderer({ antialias: true , alpha:true})\n\n    var light = new THREE.HemisphereLight(0xBEDDED, 0xDECADE, 0.55);\n    this.scene.add(light)\n    light = new THREE.SpotLight(0xffffff, 0.75);\n    light.position.set(-80,100,100);\n    light.castShadow = true;\n    this.scene.add(light)\n\n    this.addModel()\n\n    this.camera.position.z = 0.5\n    this.camera.position.y = 0\n\n    this.controls = new OrbitControls(this.camera, this.renderer.domElement);\n    this.controls.update();\n\n    this.renderer.setClearColor('#ffffff')\n    this.renderer.setSize(width, height)\n\n    window.addEventListener('resize', this.onWindowResize, false);\n\n    this.mount.appendChild(this.renderer.domElement)\n\n    this.start()\n  }\n\n  componentDidUpdate(prevProps){\n      if(prevProps.animationStatus !== this.props.animationStatus){\n          this.setState({\n              animationStatus: this.props.animationStatus\n          })\n      }\n      if(prevProps.visemes !== this.props.visemes){\n        this.visemes = this.props.visemes\n        this.visemesNames = [...new Set(this.props.visemes)]\n        this.currentFrame = 1\n        console.log(this.visemes)\n        console.log(this.visemesNames)\n    }\n    if(prevProps.sliderValue !== this.props.sliderValue){\n      this.setState({\n        intensity: this.props.sliderValue\n      })\n    }\n  }\n\n\n  addCube(x, y, z) {\n    var geometry = new THREE.BoxGeometry(.1,.1,.1)\n    geometry.translate(x, y, z)\n    var material = new THREE.MeshBasicMaterial({ color: '#433F81' })\n    var cube = new THREE.Mesh(geometry, material)\n    this.scene.add(cube)\n  }\n\n  addModel() {\n    var loader = new GLTFLoader();\n\n    loader.load('model/head_visemes.gltf', gltf => {\n      this.model = SkeletonUtils.clone(gltf.scene)\n      console.log(this.model)\n      this.scene.add(this.model)\n      this.getModelControl()\n      this.renderScene()\n    }, undefined, function (error) {\n      console.error(error);\n    }\n    )\n  }\n\n  onWindowResize() {\n    this.camera.aspect = window.innerWidth / window.innerHeight;\n    this.camera.updateProjectionMatrix();\n\n    this.renderer.setSize(window.innerWidth, window.innerHeight);\n\n  }\n\n  componentWillUnmount() {\n    this.mount.removeChild(this.renderer.domElement)\n  }\n\n  start() {\n    if (!this.frameId) {\n      this.frameId = requestAnimationFrame(this.animate)\n    }\n  }\n\n\n  getModelControl() {\n    if (this.model) {\n      this.model.traverse(o => {\n        if (o.isMesh && o.name === 'head') {\n          this.modelControl = o.morphTargetInfluences;\n          this.modelControlDict = o.morphTargetDictionary;\n          this.modelControlActive = true\n        }\n      })\n    }\n  }\n\n\n  calculateDistance(point1, point2) {\n    return Math.sqrt(Math.pow(point1[0] - point2[0], 2) + Math.pow(point1[1] - point2[1], 2))\n  }\n\n\n  moveLid(){\n    if(this.modelControl[this.modelControlDict['wink']] <= 0){\n      if (this.lidWait > 100){\n        this.lidMove = this.lidSpeed;\n        this.lidWait = 0\n      }\n      else {\n        this.lidMove = 0\n      }\n      this.lidWait += 1\n    }\n    else if (this.modelControl[this.modelControlDict['wink']] > 1) {\n      this.lidMove = -this.lidMove;\n    }\n\n    this.modelControl[this.modelControlDict['wink']] = this.modelControl[this.modelControlDict['wink']] + this.lidMove;\n  }\n\n  nextViseme(){\n    if(this.currentFrame < 1)\n      this.currentFrame = 1\n\n    var currViseme = this.visemes[this.currentFrame]\n    var prevViseme = this.visemes[this.currentFrame-1]\n    for(var visemeName of this.visemesNames){\n      if(visemeName === currViseme){\n        this.modelControl[this.modelControlDict[visemeName]] += this.state.intensity / this.exponent //Math.pow(this.state.intensity, this.exponent)\n        if(this.modelControl[this.modelControlDict[visemeName]]>1)\n          this.modelControl[this.modelControlDict[visemeName]] = 1\n      }\n      else{\n        this.modelControl[this.modelControlDict[visemeName]] -= this.state.intensity / (10-this.exponent) //Math.pow(this.state.intensity, this.exponent)\n        if(this.modelControl[this.modelControlDict[visemeName]]<0)\n          this.modelControl[this.modelControlDict[visemeName]] = 0\n      }\n    }\n\n    if(currViseme === prevViseme){\n      this.exponent -= 1\n      if(this.exponent < 2) this.exponent = 2;\n    }\n    else\n      this.exponent = 8\n  }\n\n  resetModel(){\n    this.lidWait = 0\n    if(this.modelControl){\n      for(var i=0; i<this.modelControl.length; i++){\n        this.modelControl[i] = 0;\n      }\n    }\n  }\n\n  animate() {\n    if (this.state.animationStatus === 'PLAY' && this.modelControlActive) {\n      this.nextViseme()\n      this.moveLid()\n\n      if (this.currentFrame >= this.visemes.length) {\n        this.currentFrame = 0\n      }\n\n      this.currentFrame += 1\n    }\n    else if(this.state.animationStatus === \"STOP\"){\n        this.currentFrame = 1\n        this.resetModel()\n    }\n\n    this.controls.update()\n    this.renderScene()\n    this.frameId = window.requestAnimationFrame(this.animate)\n  }\n\n  renderScene() {\n    this.renderer.render(this.scene, this.camera)\n  }\n\n  render() {\n    return (\n        <div\n          ref={(mount) => { this.mount = mount }}\n        />\n    )\n  }\n}\n\nexport default Model"]},"metadata":{},"sourceType":"module"}